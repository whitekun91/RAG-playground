<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAG Playground - AI ì–´ì‹œìŠ¤í„´íŠ¸</title>
    <link rel="stylesheet" href="/static/style.css?v=3.0">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– RAG Playground</h1>
            <p>AI-Powered Document Search & Analysis</p>
            <p>STT Â· TTS Â· RAG í†µí•© ì„œë¹„ìŠ¤</p>
            <div class="service-badges">
                <span class="badge rag-badge">ğŸ“š RAG</span>
                <span class="badge stt-badge">ğŸ¤ STT</span>
                <span class="badge tts-badge">ğŸ”Š TTS</span>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-content">
                        <div class="message-header">
                            <span class="sender">AI ì–´ì‹œìŠ¤í„´íŠ¸</span>
                            <span class="timestamp" id="welcomeTime"></span>
                        </div>
                        <div class="message-text">
                            ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” RAG Playground AI ì–´ì‹œìŠ¤í„´íŠ¸ì…ë‹ˆë‹¤.<br><br>
                            <strong>ğŸ“š RAG ê¸°ëŠ¥:</strong> ë¬¸ì„œ ê²€ìƒ‰ ë° ì§ˆì˜ì‘ë‹µ<br>
                            <strong>ğŸ¤ STT ê¸°ëŠ¥:</strong> ìŒì„± ì¸ì‹ ë° í…ìŠ¤íŠ¸ ë³€í™˜<br>
                            <strong>ğŸ”Š TTS ê¸°ëŠ¥:</strong> í…ìŠ¤íŠ¸ ìŒì„± ë³€í™˜<br><br>
                            í…ìŠ¤íŠ¸ë¡œ ì§ˆë¬¸í•˜ê±°ë‚˜ ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìŒì„±ìœ¼ë¡œ ì§ˆë¬¸í•´ë³´ì„¸ìš”!
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="input-options">
                    <div class="audio-options">
                        <label class="audio-toggle">
                            <input type="checkbox" id="ttsEnabled">
                            <span class="toggle-text">ğŸ”Š ìŒì„± ì¶œë ¥</span>
                        </label>
                    </div>
                </div>
                <div class="chat-input">
                    <textarea id="messageInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: 'ë¬¸ì„œì—ì„œ ê´€ë ¨ ì •ë³´ë¥¼ ì°¾ì•„ì¤˜')" rows="3"></textarea>
                    <div class="input-buttons">
                        <button id="voiceInputButton" class="voice-btn" title="ìŒì„± ì…ë ¥">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>
                        <button id="sendButton" class="send-btn">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22,2 15,22 11,13 2,9"></polygon>
          </svg>
      </button>
    </div>
                </div>
                <div class="input-hints">
                    <span class="hint">ğŸ’¡ íŒ: ì§ˆë¬¸ì˜ ì˜ë„ë¥¼ ëª…í™•íˆ í•˜ë©´ ë” ì •í™•í•œ ë‹µë³€ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>
                </div>
            </div>
        </div>
  </div>

  <script>
        // í˜„ì¬ ì‹œê°„ í‘œì‹œ
        document.getElementById('welcomeTime').textContent = new Date().toLocaleTimeString('ko-KR');
        
        // ë³€ìˆ˜ ì´ˆê¸°í™”
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const voiceInputButton = document.getElementById('voiceInputButton');
        const chatMessages = document.getElementById('chatMessages');
        const ttsEnabled = document.getElementById('ttsEnabled');
        
        // ìŒì„± ì¸ì‹ ê´€ë ¨ ë³€ìˆ˜
        let recognition = null;
        let isRecording = false;
    let mediaRecorder;
    let chunks = [];
        
        // ìŒì„± ì¸ì‹ ì´ˆê¸°í™”
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'ko-KR';
                
                recognition.onstart = function() {
                    isRecording = true;
                    voiceInputButton.classList.add('recording');
                    voiceInputButton.title = 'ìŒì„± ì¸ì‹ ì¤‘... (í´ë¦­í•˜ì—¬ ì¤‘ì§€)';
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    messageInput.value = transcript;
                    messageInput.focus();
                };
                
                recognition.onerror = function(event) {
                    console.error('ìŒì„± ì¸ì‹ ì˜¤ë¥˜:', event.error);
                    addMessage('assistant', 'ìŒì„± ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                };
                
                recognition.onend = function() {
                    isRecording = false;
                    voiceInputButton.classList.remove('recording');
                    voiceInputButton.title = 'ìŒì„± ì…ë ¥';
                };
            } else {
                voiceInputButton.style.display = 'none';
                console.warn('ì´ ë¸Œë¼ìš°ì €ëŠ” ìŒì„± ì¸ì‹ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        }
        
        // ìŒì„± ì…ë ¥ ë²„íŠ¼ ì´ë²¤íŠ¸ (MediaRecorder ì‚¬ìš©)
        voiceInputButton.addEventListener('click', async function() {
            if (isRecording) {
                // ë…¹ìŒ ì¤‘ì§€
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                return;
            }
            
            try {
                voiceInputButton.classList.add('recording');
                voiceInputButton.title = 'ë…¹ìŒ ì¤‘... (í´ë¦­í•˜ì—¬ ì¤‘ì§€)';
                
                addMessage('user', 'ğŸ™ï¸ ë…¹ìŒ ì¤‘...', null);
                
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);

        mediaRecorder.onstop = async () => {
                    addMessage('user', 'â³ ìŒì„±ì„ ì¸ì‹í•˜ê³  ìˆìŠµë‹ˆë‹¤...', null);
                    
                    // ë²„íŠ¼ ìƒíƒœ ë³µì›
                    voiceInputButton.classList.remove('recording');
                    voiceInputButton.title = 'ìŒì„± ì…ë ¥';

          const blob = new Blob(chunks, { type: 'audio/webm' });
          const formData = new FormData();
          formData.append("file", blob, "recorded.webm");
                    formData.append("return_audio", ttsEnabled.checked.toString());

                    try {
          const response = await fetch("/ask-audio-tts", {
            method: "POST",
            body: formData
          });
          const result = await response.json();

                        // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                        removeLastMessage();
                        
                        if (result.rag_answer) {
                            addMessage('assistant', result.rag_answer, null, result.image_urls, result.download_url);
          } else {
                            addMessage('assistant', 'ìŒì„± ì¸ì‹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', null);
                        }
                    } catch (error) {
                        console.error('ìŒì„± ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                        removeLastMessage();
                        addMessage('assistant', 'ìŒì„± ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', null);
          }
        };

        mediaRecorder.start();
        setTimeout(() => {
                    if (mediaRecorder.state === "recording") {
                        mediaRecorder.stop();
                    }
                }, 9000); // 9ì´ˆ ë…¹ìŒ ì œí•œ

      } catch (err) {
                console.error('ë§ˆì´í¬ ì ‘ê·¼ ì˜¤ë¥˜:', err);
                voiceInputButton.classList.remove('recording');
                voiceInputButton.title = 'ìŒì„± ì…ë ¥';
                addMessage('assistant', 'âš ï¸ ë§ˆì´í¬ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message, null);
            }
        });
        
        // ë©”ì‹œì§€ ì „ì†¡
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€
            addMessage('user', message);
            messageInput.value = '';
            
            // ë¡œë”© ë©”ì‹œì§€ ì¶”ê°€
            const loadingId = addLoadingMessage();
            
            try {
                const response = await fetch("/ask-text", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question: message,
                        return_audio: ttsEnabled.checked
                    })
                });
                
                const data = await response.json();
                
                // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                removeLoadingMessage(loadingId);
                
                // ì‘ë‹µ í‘œì‹œ
                addMessage('assistant', data.rag_answer || "ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", null, data.image_urls, data.download_url);
                
            } catch (error) {
                console.error('Error:', error);
                removeLoadingMessage(loadingId);
                addMessage('assistant', 'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }
        
        function addMessage(sender, content, meta = null, imageUrls = null, audioUrl = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const senderName = sender === 'user' ? 'ì‚¬ìš©ì' : 'AI ì–´ì‹œìŠ¤í„´íŠ¸';
            
            // ìŒì„± ì¬ìƒ ë²„íŠ¼ ì¶”ê°€ (AI ì‘ë‹µì´ê³  ì˜¤ë””ì˜¤ URLì´ ìˆì„ ë•Œ)
            const audioButton = (sender === 'assistant' && audioUrl) ? 
                `<button class="audio-play-btn" onclick="playAudio('${audioUrl}')" title="ìŒì„± ì¬ìƒ">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5,3 19,12 5,21"></polygon>
                    </svg>
                </button>` : '';
            
            let messageContent = content;
            
            // ì´ë¯¸ì§€ í‘œì‹œ
            if (Array.isArray(imageUrls) && imageUrls.length > 0) {
                messageContent += `
                    <div class="images-section">
                        <h4>ê´€ë ¨ ì´ë¯¸ì§€:</h4>
                        <div class="image-gallery">
                            ${imageUrls.map(imageUrl => `
                                <div class="image-item">
                                    <img src="${imageUrl}" alt="ê´€ë ¨ ì´ë¯¸ì§€" class="response-image" onclick="openImageModal('${imageUrl}')">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <span class="sender">${senderName}</span>
                        <span class="timestamp">${timestamp}</span>
                        ${audioButton}
                    </div>
                    <div class="message-text">${messageContent}</div>
                    ${meta ? `<div class="meta">${meta}</div>` : ''}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addLoadingMessage() {
            const loadingId = 'loading-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.id = loadingId;
            messageDiv.className = 'message assistant loading';
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <span class="sender">AI ì–´ì‹œìŠ¤í„´íŠ¸</span>
                        <span class="timestamp">${new Date().toLocaleTimeString('ko-KR')}</span>
                    </div>
                    <div class="message-text">
                        <div class="loading-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span class="loading-text">ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return loadingId;
        }
        
        function removeLoadingMessage(loadingId) {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
                loadingElement.remove();
            }
        }
        
        function removeLastMessage() {
            const messages = chatMessages.querySelectorAll('.message');
            if (messages.length > 0) {
                messages[messages.length - 1].remove();
            }
        }
        
        // ìŒì„± ì¬ìƒ í•¨ìˆ˜
        function playAudio(audioUrl) {
            const audio = new Audio(audioUrl);
            audio.play().catch(error => {
                console.error('ìŒì„± ì¬ìƒ ì˜¤ë¥˜:', error);
                addMessage('assistant', 'ìŒì„± ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }
        
        // ì´ë¯¸ì§€ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜
        function openImageModal(imageUrl) {
            // ëª¨ë‹¬ì´ ì´ë¯¸ ìˆìœ¼ë©´ ì œê±°
            const existingModal = document.getElementById('imageModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // ëª¨ë‹¬ ìƒì„±
            const modal = document.createElement('div');
            modal.id = 'imageModal';
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeImageModal()"></div>
                <div class="modal-content">
                    <button class="modal-close" onclick="closeImageModal()">&times;</button>
                    <img src="${imageUrl}" alt="í™•ëŒ€ ì´ë¯¸ì§€" class="modal-image">
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeImageModal();
                }
            });
        }
        
        // ì´ë¯¸ì§€ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // ìŒì„± ì¸ì‹ ì´ˆê¸°í™” ì‹¤í–‰
        initSpeechRecognition();
  </script>
</body>
</html>