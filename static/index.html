<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🤖 RAG Playground - AI 어시스턴트</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 RAG Playground</h1>
            <p>Retrieval-Augmented Generation AI Assistant</p>
            <p>문서 검색 기반 질의응답 서비스</p>
            <div class="service-badges">
                <span class="badge rag-badge">📚 RAG</span>
                <span class="badge stt-badge">🎤 STT</span>
                <span class="badge tts-badge">🔊 TTS</span>
            </div>
        </div>
        
        <div class="chat-container">
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-content">
                        <div class="message-header">
                            <span class="sender">AI 어시스턴트</span>
                            <span class="timestamp" id="welcomeTime"></span>
                        </div>
                        <div class="message-text">
                            안녕하세요! 저는 RAG 기반 AI 어시스턴트입니다.<br><br>
                            <strong>📚 RAG 기능:</strong> 문서 검색 및 질의응답<br>
                            <strong>🎤 STT 기능:</strong> 음성 인식으로 질문 입력<br>
                            <strong>🔊 TTS 기능:</strong> 음성으로 답변 듣기<br><br>
                            텍스트로 질문하거나 음성으로 말씀해주세요!
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="chat-input-container">
                <div class="input-options">
                    <div class="audio-options">
                        <label class="audio-toggle">
                            <input type="checkbox" id="ttsEnabled">
                            <span class="toggle-text">🔊 음성 출력</span>
                        </label>
                    </div>
                </div>
                <div class="chat-input">
                    <textarea id="messageInput" placeholder="질문을 입력하세요... (예: '문서에서 관련 정보를 찾아줘')" rows="3"></textarea>
                    <div class="input-buttons">
                        <button id="voiceInputButton" class="voice-btn" title="음성 입력">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                                <line x1="12" y1="19" x2="12" y2="23"></line>
                                <line x1="8" y1="23" x2="16" y2="23"></line>
                            </svg>
                        </button>
                        <button id="sendButton" class="send-btn">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22,2 15,22 11,13 2,9"></polygon>
          </svg>
      </button>
    </div>
                </div>
                <div class="input-hints">
                    <span class="hint">💡 팁: 질문을 명확하게 하면 더 정확한 답변을 받을 수 있습니다.</span>
                </div>
            </div>
        </div>
  </div>

  <script>
        // 현재 시간 표시
        document.getElementById('welcomeTime').textContent = new Date().toLocaleTimeString('ko-KR');
        
        // 변수 초기화
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const voiceInputButton = document.getElementById('voiceInputButton');
        const chatMessages = document.getElementById('chatMessages');
        const ttsEnabled = document.getElementById('ttsEnabled');
        
        // 음성 인식 관련 변수
        let recognition = null;
        let isRecording = false;
        let mediaRecorder = null;
    let chunks = [];
        
        // 음성 인식 초기화
        function initSpeechRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'ko-KR';
                
                recognition.onstart = function() {
                    isRecording = true;
                    voiceInputButton.classList.add('recording');
                    voiceInputButton.title = '음성 인식 중... (클릭하여 중지)';
                };
                
                recognition.onresult = function(event) {
                    const transcript = event.results[0][0].transcript;
                    messageInput.value = transcript;
                    messageInput.focus();
                };
                
                recognition.onerror = function(event) {
                    console.error('음성 인식 오류:', event.error);
                    addMessage('assistant', '음성 인식 중 오류가 발생했습니다. 다시 시도해주세요.');
                };
                
                recognition.onend = function() {
                    isRecording = false;
                    voiceInputButton.classList.remove('recording');
                    voiceInputButton.title = '음성 입력';
                };
            } else {
                voiceInputButton.style.display = 'none';
                console.warn('이 브라우저는 음성 인식을 지원하지 않습니다.');
            }
        }
        
        // 음성 입력 버튼 이벤트
        voiceInputButton.addEventListener('click', function() {
            if (!recognition) {
                addMessage('assistant', '음성 인식이 지원되지 않는 브라우저입니다.');
                return;
            }
            
            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
            }
        });
        
        // 메시지 전송
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // 사용자 메시지 추가
            addMessage('user', message);
            messageInput.value = '';
            
            // 로딩 메시지 추가
            const loadingId = addLoadingMessage();
            
            try {
                // RAG API 호출
                const response = await fetch('/ask-text', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        question: message,
                        return_audio: ttsEnabled.checked
                    })
                });
                
                const data = await response.json();
                
                // 로딩 메시지 제거
                removeLoadingMessage(loadingId);
                
                // 응답 표시
                displayResponse(data);
                
            } catch (error) {
                console.error('Error:', error);
                removeLoadingMessage(loadingId);
                addMessage('assistant', '죄송합니다. 오류가 발생했습니다. 다시 시도해주세요.');
            }
        }
        
        function addMessage(sender, content, type = 'text', audioUrl = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const senderName = sender === 'user' ? '사용자' : 'AI 어시스턴트';
            
            // 음성 재생 버튼 추가 (AI 응답이고 오디오 URL이 있을 때)
            const audioButton = (sender === 'assistant' && audioUrl) ? 
                `<button class="audio-play-btn" onclick="playAudio('${audioUrl}')" title="음성 재생">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5,3 19,12 5,21"></polygon>
                    </svg>
                </button>` : '';
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <span class="sender">${senderName}</span>
                        <span class="timestamp">${timestamp}</span>
                        ${audioButton}
                    </div>
                    <div class="message-text">${content}</div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function addLoadingMessage() {
            const loadingId = 'loading-' + Date.now();
            const messageDiv = document.createElement('div');
            messageDiv.id = loadingId;
            messageDiv.className = 'message assistant loading';
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    <div class="message-header">
                        <span class="sender">AI 어시스턴트</span>
                        <span class="timestamp">${new Date().toLocaleTimeString('ko-KR')}</span>
                    </div>
                    <div class="message-text">
                        <div class="loading-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                        <span class="loading-text">답변을 생성하고 있습니다...</span>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            return loadingId;
        }
        
        function removeLoadingMessage(loadingId) {
            const loadingElement = document.getElementById(loadingId);
            if (loadingElement) {
                loadingElement.remove();
            }
        }
        
        function displayResponse(data) {
            let content = '';
            
            // RAG 응답 처리
            content = `
                <div class="service-badge">📚 RAG</div>
                <div class="response-content">
                    <p><strong>답변:</strong> ${data.rag_answer || data.answer || data.response || '답변을 생성할 수 없습니다.'}</p>
                    ${data.image_urls && data.image_urls.length > 0 ? `
                        <div class="images-section">
                            <h4>관련 이미지:</h4>
                            <div class="image-gallery">
                                ${data.image_urls.map(imageUrl => `
                                    <div class="image-item">
                                        <img src="${imageUrl}" alt="관련 이미지" class="response-image" onclick="openImageModal('${imageUrl}')">
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    ${data.elapsed_time ? `<p class="debug-info">처리 시간: ${data.elapsed_time}</p>` : ''}
                </div>
            `;
            
            addMessage('assistant', content, 'response', data.download_url);
        }
        
        // 음성 재생 함수
        function playAudio(audioUrl) {
            const audio = new Audio(audioUrl);
            audio.play().catch(error => {
                console.error('음성 재생 오류:', error);
                addMessage('assistant', '음성 재생 중 오류가 발생했습니다.');
            });
        }
        
        // 이미지 모달 열기 함수
        function openImageModal(imageUrl) {
            // 모달이 이미 있으면 제거
            const existingModal = document.getElementById('imageModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // 모달 생성
            const modal = document.createElement('div');
            modal.id = 'imageModal';
            modal.className = 'image-modal';
            modal.innerHTML = `
                <div class="modal-overlay" onclick="closeImageModal()"></div>
                <div class="modal-content">
                    <button class="modal-close" onclick="closeImageModal()">&times;</button>
                    <img src="${imageUrl}" alt="확대 이미지" class="modal-image">
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // ESC 키로 모달 닫기
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeImageModal();
                }
            });
        }
        
        // 이미지 모달 닫기 함수
        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            if (modal) {
                modal.remove();
            }
        }
        
        // 음성 인식 초기화 실행
        initSpeechRecognition();
  </script>
</body>
</html>