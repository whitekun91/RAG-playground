<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>STT¬∑Ï±ÑÌåÖ Ï±óÎ¥á</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    html, body {
      height: 100%; margin: 0; padding: 0; box-sizing: border-box;
      font-family: 'Segoe UI', 'Apple SD Gothic Neo', sans-serif;
      background: #eef1f5;
    }
    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .chat-box {
      box-sizing: border-box;
      width: 98vw;
      max-width: 900px;
      min-width: 280px;
      height: 90vh;
      max-height: 95vh;
      margin: 24px auto 0 auto;
      border-radius: 20px;
      border: 1.5px solid #b5c3d2;
      background: #fff;
      box-shadow: 0 2px 18px 0 rgba(48, 66, 105, 0.12);
      display: flex;
      flex-direction: column;
      padding: 22px 14px 12px 14px;
      transition: box-shadow .2s;
    }
    .chat-box:focus-within {
      box-shadow: 0 4px 32px 0 rgba(48,66,105,0.22);
    }
    .chat-history {
      flex: 1 1 0;
      min-height: 120px;
      max-height: 100%;
      overflow-y: auto;
      margin-bottom: 14px;
      padding: 12px 8px 4px 4px;
      background: #fafbfc;
      border-radius: 10px;
      border: 1px solid #e0e6ed;
      font-size: 17px;
      word-break: break-word;
      scroll-behavior: smooth;
    }
    .chat-msg { margin: 13px 0; }
    .user-msg { font-weight: bold; color: #2576e8; }
    .bot-msg { color: #222; }
    .meta { font-size: 13px; color: #969caa; margin: 4px 0 0 0; }
    .image-container img {
      max-width: 96vw;
      max-width: 580px;
      margin-bottom: 7px;
      display: block;
      border-radius: 7px;
      border: 1px solid #d1d9e4;
      background: #fff;
      box-shadow: 0 1px 4px #ddd7;
    }
    .image-container { margin: 13px 0 0 0; }
    .input-row {
      display: flex; gap: 7px; margin-bottom: 8px;
    }
    input[type="text"] {
      flex: 1;
      padding: 13px;
      font-size: 19px;
      border-radius: 10px;
      border: 1.5px solid #bfc9da;
      background: #f5f7fa;
      transition: border .2s;
    }
    input[type="text"]:focus {
      border: 1.5px solid #2576e8;
      outline: none;
      background: #fff;
    }
    button {
      padding: 0 20px;
      border-radius: 9px;
      font-size: 19px;
      border: 1.5px solid #bfc9da;
      background: #f0f4f9;
      cursor: pointer;
      min-width: 56px;
      height: 46px;
      transition: background .15s, border .15s;
      display: flex; align-items: center; justify-content: center;
    }
    button:active, button:focus {
      background: #dde7f9;
      border-color: #2576e8;
      outline: none;
    }
    .mic-icon {
      width: 26px; height: 26px; vertical-align: -3px;
      display: inline-block;
      transition: fill 0.2s;
    }
    .mic-recording .mic-svg {
      fill: #e44857 !important;
      animation: pulse 1s infinite alternate;
    }
    @keyframes pulse {
      0%   { filter: drop-shadow(0 0 0 #e44857); }
      100% { filter: drop-shadow(0 0 8px #e44857); }
    }
    label { cursor: pointer; font-size: 16px; color: #555; }
    #ttsToggle { transform: scale(1.16); margin-right: 3px; vertical-align: -2px;}
    @media (max-width: 700px) {
      .chat-box {
        width: 100vw;
        height: 98vh;
        max-width: 100vw;
        margin: 0; border-radius: 0;
        padding: 10px 2vw 8px 2vw;
      }
      .chat-history { font-size: 16px; padding: 10px 2px 3px 2px; }
      input[type="text"] { font-size: 17px; padding: 10px; }
      button { font-size: 17px; height: 42px; min-width: 46px; padding: 0 12px; }
      .image-container img { max-width: 94vw; }
      .mic-icon { width: 22px; height: 22px; }
    }
  </style>
</head>
<body>
  <div class="chat-box">
    <div class="chat-history" id="chatHistory"></div>
    <div class="input-row">
      <input type="text" id="chatInput" placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÍ±∞ÎÇò ÎßàÏù¥ÌÅ¨ Î≤ÑÌäºÏùÑ ÎàåÎü¨Î≥¥ÏÑ∏Ïöî!" autocomplete="off" />
      <button id="sendBtn">Ï†ÑÏÜ°</button>
      <button id="micBtn" title="ÏùåÏÑ± ÏûÖÎ†•">
        <span id="micIcon" class="mic-icon">
          <!-- Í∏∞Î≥∏ ÎßàÏù¥ÌÅ¨ SVG -->
          <svg class="mic-svg" width="100%" height="100%" viewBox="0 0 24 24" fill="#888" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 16a4 4 0 0 0 4-4V6a4 4 0 1 0-8 0v6a4 4 0 0 0 4 4zm5-4a1 1 0 0 1 2 0c0 4.18-3.06 7-7 7s-7-2.82-7-7a1 1 0 1 1 2 0c0 2.97 2.16 5 5 5s5-2.03 5-5zm-5 7a1 1 0 0 1 1 1v1.25a1 1 0 1 1-2 0V20a1 1 0 0 1 1-1z"/>
          </svg>
        </span>
      </button>
    </div>
    <label>
      <input type="checkbox" id="ttsToggle" />
      TTS Ï∂úÎ†• (On/Off)
    </label>
  </div>

  <script>
    let mediaRecorder;
    let chunks = [];
    const chatHistory = document.getElementById('chatHistory');
    const chatInput = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const micIcon = document.getElementById('micIcon');
    const ttsToggle = document.getElementById('ttsToggle');

    // Î©îÏãúÏßÄ Ï∂îÍ∞Ä Ìï®Ïàò
    function addMsg(type, text, meta, imageUrls, audioUrl) {
      const wrap = document.createElement('div');
      wrap.className = 'chat-msg ' + (type === 'user' ? 'user-msg' : 'bot-msg');
      wrap.innerHTML = `<div>${text}</div>`;
      if (meta) {
        wrap.innerHTML += `<div class="meta">${meta}</div>`;
      }
      // Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÏúºÎ©¥ Ï∂úÎ†•
      if (Array.isArray(imageUrls) && imageUrls.length > 0) {
        const imageDiv = document.createElement('div');
        imageDiv.className = "image-container";
        imageUrls.forEach(url => {
          const img = document.createElement("img");
          img.src = url;
          imageDiv.appendChild(img);
        });
        wrap.appendChild(imageDiv);
      }
      // Ïò§ÎîîÏò§Í∞Ä ÏûàÏúºÎ©¥ Ïû¨ÏÉù
      if (audioUrl) {
        const audio = document.createElement('audio');
        audio.src = audioUrl;
        audio.controls = true;
        audio.style.marginTop = "5px";
        wrap.appendChild(audio);
        if (ttsToggle.checked) audio.play();
      }
      chatHistory.appendChild(wrap);
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // ÌÖçÏä§Ìä∏ ÏßàÎ¨∏ Î≥¥ÎÇ¥Í∏∞
    async function sendTextQuestion() {
      const question = chatInput.value.trim();
      if (!question) return;
      addMsg('user', question, null);
      chatInput.value = "";

      addMsg('bot', '‚è≥ ÎãµÎ≥Ä ÏÉùÏÑ± Ï§ë...', null);

      const resp = await fetch("/ask-text", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ question, return_audio: ttsToggle.checked })
      });
      const result = await resp.json();

      // Ïù¥Ï†Ñ ÎãµÎ≥Ä(Î°úÎî©) ÏÇ≠Ï†ú
      let loadingNodes = chatHistory.querySelectorAll('.bot-msg');
      if (loadingNodes.length) {
        let last = loadingNodes[loadingNodes.length - 1];
        if (last && last.textContent.includes('‚è≥ ÎãµÎ≥Ä ÏÉùÏÑ± Ï§ë')) last.remove();
      }

      addMsg(
        'bot',
        result.rag_answer || "ÏùëÎãµ ÏóÜÏùå",
        (result.opc_command ? `OPC: ${result.opc_command}, Ïã§ÌñâÍ≤∞Í≥º: ${result.opc_executed ? "ÏÑ±Í≥µ" : "Ïã§Ìå®"}` : null),
        result.image_urls,
        result.download_url
      );
    }

    // Enter ÌÇ§ Ï≤òÎ¶¨
    chatInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        sendTextQuestion();
      }
    });
    sendBtn.onclick = sendTextQuestion;

    // ÏùåÏÑ± ÏßàÎ¨∏ (STT)
    micBtn.onclick = async () => {
      try {
        micBtn.disabled = true;
        // ÎßàÏù¥ÌÅ¨ ÎÖπÏùå ÏãúÏûë: ÏïÑÏù¥ÏΩò ÏÉâÏÉÅ/Ïï†ÎãàÎ©îÏù¥ÏÖò Î∞îÍøà
        micIcon.classList.add("mic-recording");
        micIcon.querySelector('.mic-svg').setAttribute('fill', '#e44857');

        addMsg('user', 'üéôÔ∏è ÎÖπÏùå ÏãúÏûë...', null);
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        chunks = [];

        mediaRecorder.ondataavailable = e => chunks.push(e.data);

        mediaRecorder.onstop = async () => {
          addMsg('user', '‚è≥ ÏùåÏÑ± Ïù∏Ïãù Ï§ë...', null);

          // ÎßàÏù¥ÌÅ¨ ÏïÑÏù¥ÏΩò ÏõêÎ≥µ
          micIcon.classList.remove("mic-recording");
          micIcon.querySelector('.mic-svg').setAttribute('fill', '#888');
          micBtn.disabled = false;

          const blob = new Blob(chunks, { type: 'audio/webm' });
          const formData = new FormData();
          formData.append("file", blob, "recorded.webm");
          formData.append("return_audio", ttsToggle.checked.toString());

          // (1) Î®ºÏ†Ä STTÎßå Î∞õÍ≥†, Í≤∞Í≥ºÎ•º chatInputÏóê ÎùÑÏõåÏ§å
          const response = await fetch("/ask-audio-tts", {
            method: "POST",
            body: formData
          });
          const result = await response.json();

          if (result.stt_text) {
            chatInput.value = result.stt_text;
            chatInput.focus();
            addMsg('bot', `üìù Ïù∏ÏãùÎêú ÏßàÎ¨∏ÏùÑ ÌôïÏù∏/ÏàòÏ†ï ÌõÑ Ï†ÑÏÜ°ÌïòÏÑ∏Ïöî.`, null);
          } else {
            addMsg('bot', "ÏùåÏÑ± Ïù∏Ïãù Ïã§Ìå®!", null);
          }
        };

        mediaRecorder.start();
        setTimeout(() => {
          if (mediaRecorder.state === "recording") mediaRecorder.stop();
        }, 9000); // 9Ï¥à ÎÖπÏùå Ï†úÌïú

      } catch (err) {
        micIcon.classList.remove("mic-recording");
        micIcon.querySelector('.mic-svg').setAttribute('fill', '#888');
        addMsg('bot', '‚ö†Ô∏è ÎßàÏù¥ÌÅ¨ Ï†ëÍ∑º Ïã§Ìå®: ' + err, null);
        micBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
